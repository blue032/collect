<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>map</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    // 이거 보여?
    <style>
    #checkboxContainer { 
        position: absolute;
        top: 110px; 
        right: 10px;
        z-index: 100;
        background-color: rgb(218, 240, 113);
        padding: 10px;
        border-radius: 5px;
        max-width: 150px;
    }
    
    .datepicker-container {
        position: absolute;
        top: 25px;
        right: 180px;
        z-index: 200; /* 날짜 선택 위에 올리기 */
    }
    
    .button-container {
        display: flex;
        align-items: center;
        position: absolute;
        top: 25px;
        right: 10px;
    }

    .button-container input {
        margin-right: 10px;
        padding: 8px 12px; /* 버튼 내용의 패딩을 조절하여 크기를 변경 */
        font-size: 14px; /* 폰트 크기 조절 */
        border: 2px solid #000; /* 버튼 테두리 굵기 및 색상 변경 */
        border-radius: 5px; /* 버튼 모서리 둥글게 */
	}
    
    .checkboxGroup {
        display: flex;
        flex-direction: column;
        margin-bottom: 5px;
    }
    
    .checkboxLabel {
        margin: 2px 0;
    }
    
    .title {
        position: absolute;
        top: 25px;
        left: 25px;
        font-size: 20px;
        font-weight: bold; /* 글씨를 굵게 설정 */
    }
    
    </style>
    
</head>
<body>
<div class="title">V2X와 C-ITS를 활용한 교통 정보 수집과 분석</div>

<div class="button-container">
    <input id="getDataButton" type="button" value="데이터 가져오기" onclick="getData();">
</div>

<div class="datepicker-container">
    <input type="text" id="startDate" style="padding: 8px 12px; font-size: 14px; border: 2px solid #000; /* 버튼 테두리 굵기 및 색상 변경 */"/>
	<span> ~ </span>
	<input type="text" id="endDate" style="padding: 8px 12px; font-size: 14px; border: 2px solid #000; /* 버튼 테두리 굵기 및 색상 변경 */"/>
</div>

<br/><br/><br/><br/>

<div id="map" style="width:1260px;height:600px;"></div>

<div id = "checkboxContainer">
	<div class = "checkboxGroup">
		<label class = "checkbox">
			<input id="lineCheckBox" type="checkbox" name="line" > 차선 이탈
		</label>
	</div>
	
	<div class = "checkboxGroup">
		<label class = "checkboxLabel">
			<input id="pedestrianCheckBox" type="checkbox" name="pedestrian" > 보행자 충돌
		</label>
	</div>
	
		<div class = "checkboxGroup">
		<label class = "checkboxLabel">
			<input id="dangerCheckBox" type="checkbox" name="danger" > 위험구간
		</label>
	</div>
	
	<div class = "checkboxGroup">
		<label class = "checkboxLabel">
			<input id="frontCheckBox" type="checkbox" name="front" > 전방추돌
		</label>
	</div>
	
	
</div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3146c1c993d2fc8e50666c0efbf85f30&libraries=services,clusterer,drawing"></script>
<script>
	const lineCheckBox = document.getElementById('lineCheckBox');
	const pedestrianCheckBox = document.getElementById('pedestrianCheckBox');
	const dangerCheckBox = document.getElementById('dangerCheckBox');
	const frontCheckBox = document.getElementById('frontCheckBox');
	const today = new Date();
	let startDay = today.getDate();
	let endDay = today.getDate();

	$(document).ready(function () {
		$.datepicker.setDefaults($.datepicker.regional['ko']);
		$("#startDate").datepicker({
			dateFormat: 'yy-mm-dd',
			changeYear: false,
			changeMonth: false,
			minDate: new Date('2023-08-07'),
			maxDate: new Date('2023-08-16'),
			onClose: function (selectedDate) {
				startDay = selectedDate.split("-")[2];
			}
		});

		$("#endDate").datepicker({
			dateFormat: 'yy-mm-dd',
			changeYear: false,
			changeMonth: false,
			minDate: new Date('2023-08-07'),
			maxDate: new Date('2023-08-16'),
			onClose: function (selectedDate) {
				endDay = selectedDate.split("-")[2];
			}
		});
		$('#startDate').datepicker('setDate', 'today');
		$('#endDate').datepicker('setDate', 'today');
	});

	let lineKey = lineCheckBox.checked;
	let frontKey = frontCheckBox.checked;
	let dangerKey = dangerCheckBox.checked;
	let pedestrianKey = frontCheckBox.checked;

	// 체크박스 상태에 따라 마커 표시 여부를 제어
	lineCheckBox.addEventListener("change", changeValue);
	frontCheckBox.addEventListener("change", changeValue);
	pedestrianCheckBox.addEventListener("change", changeValue);
	dangerCheckBox.addEventListener("change", changeValue);

	function changeValue(event) {
		lineKey = lineCheckBox.checked;
		frontKey = frontCheckBox.checked;
		dangerKey = dangerCheckBox.checked;
		pedestrianKey = pedestrianCheckBox.checked;
	//	getData();
	}

	const container = document.getElementById('map');

    let options = {
        center: new kakao.maps.LatLng(37.5642135, 127.0016985),
        level: 3
    };

	let map = new kakao.maps.Map(container, options);
	let markers = [];
	
	const getDataButton = document.getElementById('getDataButton');

    function getData() {
    	
        // 버튼이 클릭되었을 때 시각적 피드백
        getDataButton.value = "데이터 가져오는 중..."; // 버튼 텍스트 변경
        getDataButton.disabled = true; // 로딩 중에 버튼 비활성화
        
        $.ajax({
            type:'POST', //요청 메서드
            url: 'http://localhost:8080/datas/cits', //요청 URI //요청 헤더
            data: {
                "lineKey": lineKey,
                "frontKey": frontKey,
                "dangerKey": dangerKey,
                "pedestrianKey": pedestrianKey,
                "fromDate":startDay,
                "toDate":endDay
            },
            dataType : 'json', //전송할 데이터 타입
            success : function(result) {//서버로부터 응답잉 도착하면 호출될 함수
                newMap(result);
                // 데이터 가져오기가 완료된 후 버튼 모양 복원
                getDataButton.value = "데이터 가져오기"; // 원래 버튼 텍스트 복원
                getDataButton.disabled = false; // 버튼 활성화
            },
            error : function() {
                alert("error");
                // 오류 발생 후 버튼 모양 복원
                getDataButton.value = "데이터 가져오기"; // 원래 버튼 텍스트 복원
                getDataButton.disabled = false; // 버튼 활성화
            } //에러가 발생했을 때 호출될 함수
        }); //$.ajax()
    }

    function newMap(data) {
		hideMarkers();

        const lineData = data.line;
		const pedestrianData = data.pedestrian;
		const frontData = data.front;
		const dangerData = data.danger;

		inputIcons(lineData, 'line');
		inputIcons(pedestrianData, 'pedestrian');
		inputIcons(frontData, 'front');
		inputIcons(dangerData, 'danger');

    }

	function inputIcons(data, type) {

		if(!data){
			return;
		}

		let vhcleLot;
		let vhcleLat;
		let icon;
		let imgSize;
		let imgOption = {};

		for(let i = 0; i < data.length; i++){
			vhcleLot = data[i].vhcleLot;
			vhcleLat = data[i].vhcleLat;

			if(type === 'line') {
				icon = '/icons/lane-caution.png'
				imgSize = new kakao.maps.Size(35, 25);
			}
			if(type === 'pedestrian') {
				icon = '/icons/pedestrians-caution.png'
				imgSize = new kakao.maps.Size(50, 25);
			}
			if(type === 'front') {
				icon = '/icons/car-collision-caution.png';
				imgSize = new kakao.maps.Size(50, 25);
			}
			if(type === 'danger') {
				vhcleLot = data[i].detcLot;
				vhcleLat = data[i].detcLat;
				icon = '/icons/warning.png'
				imgSize = new kakao.maps.Size(25, 25);
			}
			// 마커의 이미지정보를 가지고 있는 마커이미지를 생성합니다
			let markerImage = new kakao.maps.MarkerImage(icon,imgSize, imgOption);
			let markerPosition = new kakao.maps.LatLng(vhcleLat, vhcleLot); // 마커가 표시될 위치입니다

			// 마커를 생성합니다
			let marker = new kakao.maps.Marker({
				position: markerPosition,
				image: markerImage // 마커이미지 설정
			});

			// 마커가 지도 위에 표시되도록 설정합니다
			marker.setMap(map)
			markers.push(marker);
		}
	}
		
	function hideMarkers() {
		for(const marker of markers) {
			marker.setMap(null);
		}
		markers = [];
	}

	//    window.onload = getData();
</script>



</body>
</html>